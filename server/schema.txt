
-- 1. Settings Table (存储家庭设置)
CREATE TABLE IF NOT EXISTS settings (
    family_id TEXT PRIMARY KEY,
    user_name TEXT,
    theme_key TEXT,
    balance INTEGER DEFAULT 0,
    pet_data TEXT,
    avatar_data TEXT,
    lifetime_earned INTEGER DEFAULT 0,
    achievements_data TEXT,
    created_at INTEGER,
    updated_at INTEGER
);

-- 2. Tasks Table (存储任务列表)
CREATE TABLE IF NOT EXISTS tasks (
    id TEXT,
    family_id TEXT,
    title TEXT,
    category TEXT,
    stars INTEGER,
    icon TEXT,
    updated_at INTEGER,
    PRIMARY KEY (family_id, id)
);

-- 3. Rewards Table (存储奖励列表)
CREATE TABLE IF NOT EXISTS rewards (
    id TEXT,
    family_id TEXT,
    title TEXT,
    cost INTEGER,
    icon TEXT,
    updated_at INTEGER,
    PRIMARY KEY (family_id, id)
);

-- 4. Task Logs Table (存储每日打卡记录)
CREATE TABLE IF NOT EXISTS task_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    family_id TEXT,
    date_key TEXT,
    task_id TEXT,
    created_at INTEGER
);
-- 创建索引以加速按日期查询
CREATE INDEX IF NOT EXISTS idx_logs_family_date ON task_logs(family_id, date_key);

-- 5. Transactions Table (存储积分流水)
CREATE TABLE IF NOT EXISTS transactions (
    id TEXT,
    family_id TEXT,
    date TEXT,
    description TEXT,
    amount INTEGER,
    type TEXT,
    created_at INTEGER,
    task_id TEXT,
    is_revoked INTEGER DEFAULT 0,
    PRIMARY KEY (family_id, id)
);

-- 6. Wishlist Table (存储心愿单)
CREATE TABLE IF NOT EXISTS wishlist_goals (
    id TEXT,
    family_id TEXT,
    title TEXT,
    target_cost INTEGER,
    current_saved INTEGER,
    icon TEXT,
    updated_at INTEGER,
    PRIMARY KEY (family_id, id)
);

-- [MIGRATIONS] 
-- 如果您的数据库中缺少新字段，请在 D1 Console 中运行以下语句：
-- ALTER TABLE transactions ADD COLUMN task_id TEXT;
-- ALTER TABLE transactions ADD COLUMN is_revoked INTEGER DEFAULT 0;
-- ALTER TABLE tasks ADD COLUMN icon TEXT;
